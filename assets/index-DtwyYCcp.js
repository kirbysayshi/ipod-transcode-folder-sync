(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();var r;(function(e){e.LOAD="LOAD",e.EXEC="EXEC",e.FFPROBE="FFPROBE",e.WRITE_FILE="WRITE_FILE",e.READ_FILE="READ_FILE",e.DELETE_FILE="DELETE_FILE",e.RENAME="RENAME",e.CREATE_DIR="CREATE_DIR",e.LIST_DIR="LIST_DIR",e.DELETE_DIR="DELETE_DIR",e.ERROR="ERROR",e.DOWNLOAD="DOWNLOAD",e.PROGRESS="PROGRESS",e.LOG="LOG",e.MOUNT="MOUNT",e.UNMOUNT="UNMOUNT"})(r||(r={}));const G=(()=>{let e=0;return()=>e++})(),K=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),Y=new Error("called FFmpeg.terminate()");class J{#t=null;#a={};#n={};#s=[];#o=[];loaded=!1;#r=()=>{this.#t&&(this.#t.onmessage=({data:{id:t,type:n,data:a}})=>{switch(n){case r.LOAD:this.loaded=!0,this.#a[t](a);break;case r.MOUNT:case r.UNMOUNT:case r.EXEC:case r.FFPROBE:case r.WRITE_FILE:case r.READ_FILE:case r.DELETE_FILE:case r.RENAME:case r.CREATE_DIR:case r.LIST_DIR:case r.DELETE_DIR:this.#a[t](a);break;case r.LOG:this.#s.forEach(s=>s(a));break;case r.PROGRESS:this.#o.forEach(s=>s(a));break;case r.ERROR:this.#n[t](a);break}delete this.#a[t],delete this.#n[t]})};#e=({type:t,data:n},a=[],s)=>this.#t?new Promise((o,i)=>{const u=G();this.#t&&this.#t.postMessage({id:u,type:t,data:n},a),this.#a[u]=o,this.#n[u]=i,s?.addEventListener("abort",()=>{i(new DOMException(`Message # ${u} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(K);on(t,n){t==="log"?this.#s.push(n):t==="progress"&&this.#o.push(n)}off(t,n){t==="log"?this.#s=this.#s.filter(a=>a!==n):t==="progress"&&(this.#o=this.#o.filter(a=>a!==n))}load=({classWorkerURL:t,...n}={},{signal:a}={})=>(this.#t||(this.#t=t?new Worker(new URL(t,import.meta.url),{type:"module"}):new Worker(new URL(""+new URL("worker-BAOIWoxA.js",import.meta.url).href,import.meta.url),{type:"module"}),this.#r()),this.#e({type:r.LOAD,data:n},void 0,a));exec=(t,n=-1,{signal:a}={})=>this.#e({type:r.EXEC,data:{args:t,timeout:n}},void 0,a);ffprobe=(t,n=-1,{signal:a}={})=>this.#e({type:r.FFPROBE,data:{args:t,timeout:n}},void 0,a);terminate=()=>{const t=Object.keys(this.#n);for(const n of t)this.#n[n](Y),delete this.#n[n],delete this.#a[n];this.#t&&(this.#t.terminate(),this.#t=null,this.loaded=!1)};writeFile=(t,n,{signal:a}={})=>{const s=[];return n instanceof Uint8Array&&s.push(n.buffer),this.#e({type:r.WRITE_FILE,data:{path:t,data:n}},s,a)};mount=(t,n,a)=>{const s=[];return this.#e({type:r.MOUNT,data:{fsType:t,options:n,mountPoint:a}},s)};unmount=t=>{const n=[];return this.#e({type:r.UNMOUNT,data:{mountPoint:t}},n)};readFile=(t,n="binary",{signal:a}={})=>this.#e({type:r.READ_FILE,data:{path:t,encoding:n}},void 0,a);deleteFile=(t,{signal:n}={})=>this.#e({type:r.DELETE_FILE,data:{path:t}},void 0,n);rename=(t,n,{signal:a}={})=>this.#e({type:r.RENAME,data:{oldPath:t,newPath:n}},void 0,a);createDir=(t,{signal:n}={})=>this.#e({type:r.CREATE_DIR,data:{path:t}},void 0,n);listDir=(t,{signal:n}={})=>this.#e({type:r.LIST_DIR,data:{path:t}},void 0,n);deleteDir=(t,{signal:n}={})=>this.#e({type:r.DELETE_DIR,data:{path:t}},void 0,n)}var v;(function(e){e.MEMFS="MEMFS",e.NODEFS="NODEFS",e.NODERAWFS="NODERAWFS",e.IDBFS="IDBFS",e.WORKERFS="WORKERFS",e.PROXYFS="PROXYFS"})(v||(v={}));const Q=new Error("failed to get response body reader"),V=new Error("failed to complete download"),Z="Content-Length",ee=async(e,t)=>{const n=await fetch(e);let a;try{const s=parseInt(n.headers.get(Z)||"-1"),o=n.body?.getReader();if(!o)throw Q;const i=[];let u=0;for(;;){const{done:d,value:c}=await o.read(),p=c?c.length:0;if(d){if(s!=-1&&s!==u)throw V;t&&t({url:e,total:s,received:u,delta:p,done:d});break}i.push(c),u+=p,t&&t({url:e,total:s,received:u,delta:p,done:d})}const l=new Uint8Array(u);let f=0;for(const d of i)l.set(d,f),f+=d.length;a=l.buffer}catch(s){console.log("failed to send download progress event: ",s),a=await n.arrayBuffer()}return a},U=async(e,t,n=!1,a)=>{const s=n?await ee(e,a):await(await fetch(e)).arrayBuffer(),o=new Blob([s],{type:t});return URL.createObjectURL(o)},te=new Set([".flac",".m4a",".mp3",".aac",".aiff",".wav",".alac"]);let $=null,S=null,T=[],k=new Map,R=[];const L=document.getElementById("btn-source"),O=document.getElementById("btn-target"),D=document.getElementById("btn-sync"),ne=document.getElementById("btn-select-all"),ae=document.getElementById("btn-select-none"),se=document.getElementById("source-name"),oe=document.getElementById("target-name"),m=document.getElementById("album-list"),x=document.getElementById("empty-state"),P=document.getElementById("progress-area"),re=document.getElementById("progress-text"),F=document.getElementById("progress-bar"),I=document.getElementById("error-notice"),N=document.getElementById("sync-log"),w=document.getElementById("sync-log-content");function ie(e){return e.trim().toLowerCase()}function y(e){const t=e.lastIndexOf(".");return t>=0?e.slice(t).toLowerCase():""}async function H(e){const t=[];for await(const[n,a]of e.entries()){if(a.kind!=="directory")continue;const s=[];for await(const[o,i]of a.entries())i.kind==="file"&&te.has(y(o))&&s.push(i);s.length>0&&t.push({name:n,normalizedName:ie(n),files:s})}return t.sort((n,a)=>n.name.localeCompare(a.name)),t}async function W(e){try{return await window.showDirectoryPicker({id:e,mode:"readwrite"})}catch{return null}}function M(){R=T.map(e=>{const t=k.get(e.normalizedName),n=e.files.length;let a;return t==null?a="missing":t<n?a="incomplete":a="present",{...e,status:a,targetCount:t??0}}),ce()}function ce(){if(m.innerHTML="",R.length===0){x.style.display="block",D.disabled=!0;return}x.style.display="none";for(const e of R){const t=document.createElement("li");e.status==="present"&&t.classList.add("present");const n=document.createElement("input");n.type="checkbox",n.checked=e.status!=="present",n.disabled=e.status==="present",n.dataset.album=e.normalizedName;const a=document.createElement("span");a.className="album-name",a.textContent=e.name;const s=document.createElement("span");s.className="album-meta",e.status==="incomplete"?s.textContent=`${e.targetCount}/${e.files.length} tracks`:s.textContent=`${e.files.length} track${e.files.length!==1?"s":""}`;const o=document.createElement("span"),i={missing:"Missing",incomplete:"Incomplete",present:"Present"};o.className=`badge ${e.status}`,o.textContent=i[e.status],t.append(n,a,s,o),m.appendChild(t)}g()}function q(){const e=new Set;for(const t of m.querySelectorAll("input[type=checkbox]:checked"))e.add(t.dataset.album);return R.filter(t=>e.has(t.normalizedName))}function g(){D.disabled=q().length===0}m.addEventListener("change",g);ne.addEventListener("click",()=>{for(const e of m.querySelectorAll("input[type=checkbox]:not(:disabled)"))e.checked=!0;g()});ae.addEventListener("click",()=>{for(const e of m.querySelectorAll("input[type=checkbox]"))e.checked=!1;g()});async function z(e){$=e,se.textContent=e.name,T=await H(e),S&&M()}async function X(e){S=e,oe.textContent=e.name;const t=await H(e);k=new Map(t.map(n=>[n.normalizedName,n.files.length])),$&&M()}L.addEventListener("click",async()=>{const e=await W("source");e&&await z(e)});O.addEventListener("click",async()=>{const e=await W("target");e&&await X(e)});async function le(e,t){e.preventDefault(),e.currentTarget.classList.remove("drag-over");const n=e.dataTransfer.items[0];if(!n)return;const a=await n.getAsFileSystemHandle();a?.kind!=="directory"||await a.requestPermission({mode:"readwrite"})!=="granted"||await t(a)}for(const[e,t]of[[L.closest(".folder-picker"),z],[O.closest(".folder-picker"),X]])e.addEventListener("dragover",n=>{n.preventDefault(),e.classList.add("drag-over")}),e.addEventListener("dragleave",()=>e.classList.remove("drag-over")),e.addEventListener("drop",n=>le(n,t));let A=null,j=null;async function de(){if(!A){const e=new URL(".",document.baseURI).href;A=await U(`${e}ffmpeg/ffmpeg-core.js`,"text/javascript"),j=await U(`${e}ffmpeg/ffmpeg-core.wasm`,"application/wasm")}}function b(e){w.textContent+=e+`
`,w.scrollTop=w.scrollHeight}async function ue(){const e=new J;return e.on("log",({message:t})=>b(t)),await e.load({coreURL:A,wasmURL:j}),e}function E(e,t){P.style.display="block",re.textContent=e,F.style.width=`${Math.round(t*100)}%`}function fe(){P.style.display="none",F.style.width="0%"}D.addEventListener("click",async()=>{const e=q();if(e.length===0)return;D.disabled=!0,L.disabled=!0,O.disabled=!0,w.textContent="",N.style.display="block",N.open=!1,I.style.display="none";const t=[],n=e.reduce((o,i)=>o+i.files.length,0);let a=0;e.some(o=>o.files.some(i=>y(i.name)===".flac"))&&(E("Loading ffmpeg...",0),await de());for(const o of e){const i=await S.getDirectoryHandle(o.name,{create:!0}),u=o.files.some(d=>y(d.name)===".flac");let l=null;u&&(E(`${o.name} — loading transcoder...`,a/n),l=await ue());for(const d of o.files){const c=await d.getFile(),p=y(c.name);if(E(`${o.name} — ${c.name}`,a/n),p===".flac"){const C=c.name.replace(/\.flac$/i,".m4a");b(`
--- Transcoding: ${o.name}/${c.name} ---`),await l.writeFile("input.flac",new Uint8Array(await c.arrayBuffer()));const h=await l.exec(["-i","input.flac","-map","0:a","-map","0:v?","-acodec","alac","-c:v","copy","-disposition:v","attached_pic","-map_metadata","0","output.m4a"]);if(h!==0){t.push(`${o.name}/${c.name}`),b(`ERROR: ffmpeg exited with code ${h}`),I.textContent=`${t.length} file${t.length>1?"s":""} failed to transcode. Check the sync log for details.`,I.style.display="block",await l.deleteFile("input.flac");try{await l.deleteFile("output.m4a")}catch{}}else{const _=await l.readFile("output.m4a");b(`OK: ${_.byteLength} bytes`);const B=await(await i.getFileHandle(C,{create:!0})).createWritable();await B.write(_),await B.close(),await l.deleteFile("input.flac"),await l.deleteFile("output.m4a")}}else{const h=await(await i.getFileHandle(c.name,{create:!0})).createWritable();await h.write(await c.arrayBuffer()),await h.close()}a++,E(`${o.name} — ${c.name}`,a/n)}l&&l.terminate(),k.set(o.normalizedName,o.files.length);const f=m.querySelector(`input[data-album="${CSS.escape(o.normalizedName)}"]`)?.closest("li");if(f){const d=f.querySelector(".badge");d.className="badge synced",d.textContent="Synced";const c=f.querySelector("input");c.checked=!1,c.disabled=!0,f.classList.add("present")}}t.length>0?(E(`Done with ${t.length} error${t.length>1?"s":""}`,1),N.open=!0):(E("Done!",1),setTimeout(fe,3e3)),L.disabled=!1,O.disabled=!1,g()});
