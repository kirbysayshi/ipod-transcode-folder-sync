(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();var r;(function(e){e.LOAD="LOAD",e.EXEC="EXEC",e.FFPROBE="FFPROBE",e.WRITE_FILE="WRITE_FILE",e.READ_FILE="READ_FILE",e.DELETE_FILE="DELETE_FILE",e.RENAME="RENAME",e.CREATE_DIR="CREATE_DIR",e.LIST_DIR="LIST_DIR",e.DELETE_DIR="DELETE_DIR",e.ERROR="ERROR",e.DOWNLOAD="DOWNLOAD",e.PROGRESS="PROGRESS",e.LOG="LOG",e.MOUNT="MOUNT",e.UNMOUNT="UNMOUNT"})(r||(r={}));const X=(()=>{let e=0;return()=>e++})(),j=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),G=new Error("called FFmpeg.terminate()");class K{#t=null;#a={};#n={};#s=[];#o=[];loaded=!1;#r=()=>{this.#t&&(this.#t.onmessage=({data:{id:t,type:n,data:a}})=>{switch(n){case r.LOAD:this.loaded=!0,this.#a[t](a);break;case r.MOUNT:case r.UNMOUNT:case r.EXEC:case r.FFPROBE:case r.WRITE_FILE:case r.READ_FILE:case r.DELETE_FILE:case r.RENAME:case r.CREATE_DIR:case r.LIST_DIR:case r.DELETE_DIR:this.#a[t](a);break;case r.LOG:this.#s.forEach(s=>s(a));break;case r.PROGRESS:this.#o.forEach(s=>s(a));break;case r.ERROR:this.#n[t](a);break}delete this.#a[t],delete this.#n[t]})};#e=({type:t,data:n},a=[],s)=>this.#t?new Promise((o,i)=>{const u=X();this.#t&&this.#t.postMessage({id:u,type:t,data:n},a),this.#a[u]=o,this.#n[u]=i,s?.addEventListener("abort",()=>{i(new DOMException(`Message # ${u} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(j);on(t,n){t==="log"?this.#s.push(n):t==="progress"&&this.#o.push(n)}off(t,n){t==="log"?this.#s=this.#s.filter(a=>a!==n):t==="progress"&&(this.#o=this.#o.filter(a=>a!==n))}load=({classWorkerURL:t,...n}={},{signal:a}={})=>(this.#t||(this.#t=t?new Worker(new URL(t,import.meta.url),{type:"module"}):new Worker(new URL(""+new URL("worker-BAOIWoxA.js",import.meta.url).href,import.meta.url),{type:"module"}),this.#r()),this.#e({type:r.LOAD,data:n},void 0,a));exec=(t,n=-1,{signal:a}={})=>this.#e({type:r.EXEC,data:{args:t,timeout:n}},void 0,a);ffprobe=(t,n=-1,{signal:a}={})=>this.#e({type:r.FFPROBE,data:{args:t,timeout:n}},void 0,a);terminate=()=>{const t=Object.keys(this.#n);for(const n of t)this.#n[n](G),delete this.#n[n],delete this.#a[n];this.#t&&(this.#t.terminate(),this.#t=null,this.loaded=!1)};writeFile=(t,n,{signal:a}={})=>{const s=[];return n instanceof Uint8Array&&s.push(n.buffer),this.#e({type:r.WRITE_FILE,data:{path:t,data:n}},s,a)};mount=(t,n,a)=>{const s=[];return this.#e({type:r.MOUNT,data:{fsType:t,options:n,mountPoint:a}},s)};unmount=t=>{const n=[];return this.#e({type:r.UNMOUNT,data:{mountPoint:t}},n)};readFile=(t,n="binary",{signal:a}={})=>this.#e({type:r.READ_FILE,data:{path:t,encoding:n}},void 0,a);deleteFile=(t,{signal:n}={})=>this.#e({type:r.DELETE_FILE,data:{path:t}},void 0,n);rename=(t,n,{signal:a}={})=>this.#e({type:r.RENAME,data:{oldPath:t,newPath:n}},void 0,a);createDir=(t,{signal:n}={})=>this.#e({type:r.CREATE_DIR,data:{path:t}},void 0,n);listDir=(t,{signal:n}={})=>this.#e({type:r.LIST_DIR,data:{path:t}},void 0,n);deleteDir=(t,{signal:n}={})=>this.#e({type:r.DELETE_DIR,data:{path:t}},void 0,n)}var U;(function(e){e.MEMFS="MEMFS",e.NODEFS="NODEFS",e.NODERAWFS="NODERAWFS",e.IDBFS="IDBFS",e.WORKERFS="WORKERFS",e.PROXYFS="PROXYFS"})(U||(U={}));const Y=new Error("failed to get response body reader"),J=new Error("failed to complete download"),Q="Content-Length",V=async(e,t)=>{const n=await fetch(e);let a;try{const s=parseInt(n.headers.get(Q)||"-1"),o=n.body?.getReader();if(!o)throw Y;const i=[];let u=0;for(;;){const{done:d,value:l}=await o.read(),h=l?l.length:0;if(d){if(s!=-1&&s!==u)throw J;t&&t({url:e,total:s,received:u,delta:h,done:d});break}i.push(l),u+=h,t&&t({url:e,total:s,received:u,delta:h,done:d})}const c=new Uint8Array(u);let f=0;for(const d of i)c.set(d,f),f+=d.length;a=c.buffer}catch(s){console.log("failed to send download progress event: ",s),a=await n.arrayBuffer()}return a},x=async(e,t,n=!1,a)=>{const s=n?await V(e,a):await(await fetch(e)).arrayBuffer(),o=new Blob([s],{type:t});return URL.createObjectURL(o)},Z=new Set([".flac",".m4a",".mp3",".aac",".aiff",".wav",".alac"]);let P=null,S=null,T=[],C=new Map,R=[];const D=document.getElementById("btn-source"),N=document.getElementById("btn-target"),L=document.getElementById("btn-sync"),ee=document.getElementById("btn-select-all"),te=document.getElementById("btn-select-none"),ne=document.getElementById("source-name"),ae=document.getElementById("target-name"),m=document.getElementById("album-list"),$=document.getElementById("empty-state"),F=document.getElementById("progress-area"),se=document.getElementById("progress-text"),v=document.getElementById("progress-bar"),O=document.getElementById("error-notice"),I=document.getElementById("sync-log"),b=document.getElementById("sync-log-content");function oe(e){return e.trim().toLowerCase()}function w(e){const t=e.lastIndexOf(".");return t>=0?e.slice(t).toLowerCase():""}async function W(e){const t=[];for await(const[n,a]of e.entries()){if(a.kind!=="directory")continue;const s=[];for await(const[o,i]of a.entries())i.kind==="file"&&Z.has(w(o))&&s.push(i);s.length>0&&t.push({name:n,normalizedName:oe(n),files:s})}return t.sort((n,a)=>n.name.localeCompare(a.name)),t}async function H(e){try{return await window.showDirectoryPicker({id:e,mode:"readwrite"})}catch{return null}}function M(){R=T.map(e=>{const t=C.get(e.normalizedName),n=e.files.length;let a;return t==null?a="missing":t<n?a="incomplete":a="present",{...e,status:a,targetCount:t??0}}),re()}function re(){if(m.innerHTML="",R.length===0){$.style.display="block",L.disabled=!0;return}$.style.display="none";for(const e of R){const t=document.createElement("li");e.status==="present"&&t.classList.add("present");const n=document.createElement("input");n.type="checkbox",n.checked=e.status!=="present",n.disabled=e.status==="present",n.dataset.album=e.normalizedName;const a=document.createElement("span");a.className="album-name",a.textContent=e.name;const s=document.createElement("span");s.className="album-meta",e.status==="incomplete"?s.textContent=`${e.targetCount}/${e.files.length} tracks`:s.textContent=`${e.files.length} track${e.files.length!==1?"s":""}`;const o=document.createElement("span"),i={missing:"Missing",incomplete:"Incomplete",present:"Present"};o.className=`badge ${e.status}`,o.textContent=i[e.status],t.append(n,a,s,o),m.appendChild(t)}g()}function z(){const e=new Set;for(const t of m.querySelectorAll("input[type=checkbox]:checked"))e.add(t.dataset.album);return R.filter(t=>e.has(t.normalizedName))}function g(){L.disabled=z().length===0}m.addEventListener("change",g);ee.addEventListener("click",()=>{for(const e of m.querySelectorAll("input[type=checkbox]:not(:disabled)"))e.checked=!0;g()});te.addEventListener("click",()=>{for(const e of m.querySelectorAll("input[type=checkbox]"))e.checked=!1;g()});D.addEventListener("click",async()=>{const e=await H("source");e&&(P=e,ne.textContent=e.name,T=await W(e),S&&M())});N.addEventListener("click",async()=>{const e=await H("target");if(!e)return;S=e,ae.textContent=e.name;const t=await W(e);C=new Map(t.map(n=>[n.normalizedName,n.files.length])),P&&M()});let A=null,q=null;async function ie(){if(!A){const e=new URL(".",document.baseURI).href;A=await x(`${e}ffmpeg/ffmpeg-core.js`,"text/javascript"),q=await x(`${e}ffmpeg/ffmpeg-core.wasm`,"application/wasm")}}function y(e){b.textContent+=e+`
`,b.scrollTop=b.scrollHeight}async function le(){const e=new K;return e.on("log",({message:t})=>y(t)),await e.load({coreURL:A,wasmURL:q}),e}function E(e,t){F.style.display="block",se.textContent=e,v.style.width=`${Math.round(t*100)}%`}function ce(){F.style.display="none",v.style.width="0%"}L.addEventListener("click",async()=>{const e=z();if(e.length===0)return;L.disabled=!0,D.disabled=!0,N.disabled=!0,b.textContent="",I.style.display="block",I.open=!1,O.style.display="none";const t=[],n=e.reduce((o,i)=>o+i.files.length,0);let a=0;e.some(o=>o.files.some(i=>w(i.name)===".flac"))&&(E("Loading ffmpeg...",0),await ie());for(const o of e){const i=await S.getDirectoryHandle(o.name,{create:!0}),u=o.files.some(d=>w(d.name)===".flac");let c=null;u&&(E(`${o.name} — loading transcoder...`,a/n),c=await le());for(const d of o.files){const l=await d.getFile(),h=w(l.name);if(E(`${o.name} — ${l.name}`,a/n),h===".flac"){const k=l.name.replace(/\.flac$/i,".m4a");y(`
--- Transcoding: ${o.name}/${l.name} ---`),await c.writeFile("input.flac",new Uint8Array(await l.arrayBuffer()));const p=await c.exec(["-i","input.flac","-map","0:a","-acodec","alac","output.m4a"]);if(p!==0){t.push(`${o.name}/${l.name}`),y(`ERROR: ffmpeg exited with code ${p}`),O.textContent=`${t.length} file${t.length>1?"s":""} failed to transcode. Check the sync log for details.`,O.style.display="block",await c.deleteFile("input.flac");try{await c.deleteFile("output.m4a")}catch{}}else{const B=await c.readFile("output.m4a");y(`OK: ${B.byteLength} bytes`);const _=await(await i.getFileHandle(k,{create:!0})).createWritable();await _.write(B),await _.close(),await c.deleteFile("input.flac"),await c.deleteFile("output.m4a")}}else{const p=await(await i.getFileHandle(l.name,{create:!0})).createWritable();await p.write(await l.arrayBuffer()),await p.close()}a++,E(`${o.name} — ${l.name}`,a/n)}c&&c.terminate(),C.set(o.normalizedName,o.files.length);const f=m.querySelector(`input[data-album="${CSS.escape(o.normalizedName)}"]`)?.closest("li");if(f){const d=f.querySelector(".badge");d.className="badge synced",d.textContent="Synced";const l=f.querySelector("input");l.checked=!1,l.disabled=!0,f.classList.add("present")}}t.length>0?(E(`Done with ${t.length} error${t.length>1?"s":""}`,1),I.open=!0):(E("Done!",1),setTimeout(ce,3e3)),D.disabled=!1,N.disabled=!1,g()});
